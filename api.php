<?php date_default_timezone_set("Indian/Maldives");	@$dbc = mysqli_connect("localhost","root","","paradise_attendance");	if (!$dbc) {		echo mysqli_connect_error();		exit();	}	function distance($lat1=31.4304978, $lon1=73.0669109, $lat2, $lon2, $unit) {		  $radlat1 = M_PI * $lat1/180;		  $radlat2 = M_PI * $lat2/180;		  $theta = $lon1-$lon2;		  $radtheta = M_PI * $theta/180;		  $dist = sin($radlat1) * sin($radlat2) + cos($radlat1) * cos($radlat2) * cos($radtheta);		  if ($dist > 1) {		    $dist = 1;		  }		  $dist = acos($dist);		  $dist = $dist * 180/M_PI;		  $dist = $dist * 60 * 1.1515;		  if ($unit=="K") { $dist = $dist * 1.609344; }		  if ($unit=="N") { $dist = $dist * 0.8684; }		  return $dist;	}	$data = [];	  /* Login Code */  if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="login") {    $password= md5($_REQUEST['password']);    $email  = strtolower($_REQUEST['email']);    $q=mysqli_query($dbc,"SELECT * FROM users WHERE (username='$email' OR user_email='$email') AND user_password='$password'");    if(mysqli_num_rows($q)==1){      $fetchLoginUser=mysqli_fetch_assoc($q);      $getUserRole=mysqli_query($dbc,"SELECT * FROM assign_user_role WHERE user_id='$fetchLoginUser[user_id]'");      $roles=[];      while ($fetchRole=mysqli_fetch_assoc($getUserRole)) {        $roles[]=$fetchRole['user_role'];      }      $data = [      	"user_details"=>$fetchLoginUser,        'user_role'=>$roles,        "status"=>"success",        "code"=>"200"      ];            }else{        $data = [        "status"=>"fail",        "code"=>"400"];            }  }/*Forgot Password Code*/	if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="forgot_password") {	    $email  = strtolower($_REQUEST['email']);	    $q=mysqli_query($dbc,"SELECT * FROM users WHERE (username='$email' OR user_email='$email')");	    if(mysqli_num_rows($q)==1){	      $fetchLoginUser=mysqli_fetch_assoc($q);	      mail($fetchLoginUser['user_email'],"Reset Password Link",'You requested for reset password.<br><a href="reset.php">Reset Password</a>');	      $data = [	      	"msg"=>"Your password link has been sent at your ".$fetchLoginUser['user_email'],	        "status"=>"success",	        "code"=>"200"	      ];	        	    }else{	        $data = [	        "status"=>"fail",	        "code"=>"400"];	        	    }	  }    /* Update Password Code */  if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="reset_password" AND !empty($_REQUEST['emp_id'])) {    $password= md5($_REQUEST['password']);        $q=mysqli_query($dbc,"UPDATE users SET user_password='$password' WHERE user_id='$_REQUEST[emp_id]'");   		 if($q){			 $data = [		      	"message"=>"Password has been changed",		        "status"=>"success",		        "code"=>"200"		      ];        		    }else{		        $data = [		        'message'=>mysqli_error($dbc),			        "status"=>"fail",		        "code"=>"400"];		        		    }   	}   	    /* Update Profile Code */  if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="update_profile" AND !empty($_REQUEST['emp_id'])) {  	$username=mysqli_real_escape_string($dbc,strip_tags($_REQUEST['username']));   	$name=mysqli_real_escape_string($dbc,strip_tags($_REQUEST['name']));   	$email=mysqli_real_escape_string($dbc,strip_tags($_REQUEST['email']));   	$cnic=mysqli_real_escape_string($dbc,strip_tags($_REQUEST['cnic']));   	$phone=mysqli_real_escape_string($dbc,strip_tags($_REQUEST['phone']));   	$address=mysqli_real_escape_string($dbc,strip_tags($_REQUEST['address']));    $q=mysqli_query($dbc,"UPDATE users SET username='$username',user_email='$email',user_fullname='$name',user_cnic='$cnic',user_phone='$phone',user_address='$address' WHERE user_id='$_REQUEST[emp_id]'");   		 if($q){			 $data = [		      	"message"=>"Profile has been updated",		        "status"=>"success",		        "code"=>"200"		      ];        		    }else{		        $data = [		        'message'=>mysqli_error($dbc),			        "status"=>"fail",		        "code"=>"400"];		        		    }   	}  /*Mark Attendance by QR*/	if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="mark_attendance" AND !empty($_REQUEST['emp_id']) AND !empty($_REQUEST['user_id'])) {		$img='';			$att_date = date('Y-m-d');			$att_sts = 'p';			$emp_id= $_REQUEST['emp_id'];			$admin_id = $_REQUEST['user_id'];			@$location = isset($_REQUEST['location'])?$_REQUEST['location']:'';			$description = 'Attendace Marked by QR Scan at '.date('D, d-M-Y h:i:s a');						$q=mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE emp_id='$emp_id' AND att_date='$att_date'");	    	if (mysqli_num_rows($q)>=1) {	    		$fetchEmpLast  =mysqli_fetch_assoc(mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE emp_id='$emp_id' AND att_date='$att_date' ORDER BY att_id DESC LIMIT 1"));												$start = strtotime($fetchEmpLast['in_time']); 						$end = strtotime(date("H:i:s")); 						$totaltime = ($end - $start)  ; 						$h = intval($totaltime / 3600);   						$seconds_remain = ($totaltime - ($h * 3600)); 						$m = intval($seconds_remain / 60);   						$s = ($seconds_remain - ($m * 60)); 						$remaining_emp=60-$m;	    		if($h>=1){	    			$in_time = $out_time = date('H:i:s');	    			if (!empty($fetchEmpLast['in_time']) AND !empty($fetchEmpLast['out_time'])) {	    					    				    			}else{	    				if (empty($fetchEmpLast['out_time'])) {		    					    			 mysqli_query($dbc,"UPDATE emp_attendance SET out_time='$out_time' WHERE att_id='$fetchEmpLast[att_id]'");		    		}		    		if(empty($fetchEmpLast['in_time'])){		    			 mysqli_query($dbc,"UPDATE emp_attendance SET in_time='$in_time' WHERE att_id='$fetchEmpLast[att_id]'");		    		}	    			}//when attendance marked in and out		    			    		}else{	    			 $data = [					        'message'=>'Make Difference of 1 Hour Time Left: '.abs($remaining_emp),					        "status"=>"success",					        "code"=>"200"					 		   ];	    			    		}	    	}else{	    		$in_time = date('H:i:s');	    	if (mysqli_query($dbc,"INSERT INTO emp_attendance(att_date,att_sts,emp_id,location,description,admin_id,in_time) VALUES('$att_date','$att_sts','$emp_id','$location','$description','$admin_id','$in_time')")) {				 $data = [			        'message'=>"Attendance Marked",			        "status"=>"success",			        "code"=>"200"			 		   ];		   		}else{   				 	$data = [				        'message'=>mysqli_error($dbc),				        "status"=>"fail",				        "code"=>"201"			 		   ];		    	} 	    	}//num rows	}//atendance mark action		/* Distance Based QR Attendance */		if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="mark_attendance_geolocation" AND !empty($_REQUEST['emp_id']) AND !empty($_REQUEST['lat']) AND !empty($_REQUEST['lon'])) {			$img='';			$att_date = date('Y-m-d');			$att_sts = 'p';			@$emp_id= $_REQUEST['emp_id'];			@$lat=doubleval($_REQUEST['lat']);	    	@$lon =doubleval( $_REQUEST['lon']);			@$location = $_REQUEST['lat'].",".$_REQUEST['lon'];			$description = 'Attendace Marked by QR Scan at '.date('D, d-M-Y h:i:s a');			$getSettings = mysqli_fetch_assoc(mysqli_query($dbc,"SELECT * FROM settings WHERE status='activate' ORDER BY id DESC LIMIT 1"));			$loc = explode(",",$getSettings['location']);			$lat2=$loc[0];			$lon2=$loc[1];						 $dist= distance($lat, $lon, $lat2, $lon2, 'K');			$limit =$getSettings['distance']/1000;			if($dist>$limit){				 $data = [				        'message'=>"Not allowed to mark attendance. Geolocation error",				        "status"=>"success",				        "code"=>"201"			 		   ];			}else{				$q=mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE emp_id='$emp_id' AND att_date='$att_date'");	    	if (mysqli_num_rows($q)>=1) {	    		$fetchEmpLast  =mysqli_fetch_assoc(mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE emp_id='$emp_id' AND att_date='$att_date' ORDER BY att_id DESC LIMIT 1"));												$start = strtotime($fetchEmpLast['in_time']); 						$end = strtotime(date("H:i:s")); 						$totaltime = ($end - $start)  ; 						$h = intval($totaltime / 3600);   						$seconds_remain = ($totaltime - ($h * 3600)); 						$m = intval($seconds_remain / 60);   						$s = ($seconds_remain - ($m * 60)); 						$remaining_emp=60-$m;	    		if($h>=1){	    			$in_time = $out_time = date('H:i:s');	    			if (!empty($fetchEmpLast['in_time']) AND !empty($fetchEmpLast['out_time'])) {	    				 $data = [						        'message'=>"Attendance Already Marked",						        "status"=>"success",						        "code"=>"200"				 		   ];	    				    			}else{	    				if (empty($fetchEmpLast['out_time'])) {		    					    			 mysqli_query($dbc,"UPDATE emp_attendance SET out_time='$out_time' WHERE att_id='$fetchEmpLast[att_id]'");		    			 $data = [						        'message'=>"Attendance Marked. Employee Checked OUT",						        "status"=>"success",						        "code"=>"200"				 		   ];		    		}		    		if(empty($fetchEmpLast['in_time'])){		    			 mysqli_query($dbc,"UPDATE emp_attendance SET in_time='$in_time' WHERE att_id='$fetchEmpLast[att_id]'");	    			 $data = [				        'message'=>"Attendance Marked. Employee Checked IN",				        "status"=>"success",				        "code"=>"200"				 		   ];			    		}	    			}//when attendance marked in and out		    			    		}else{	    			 $data = [					        'message'=>'Make Difference of 1 Hour Time Left: '.abs($remaining_emp),					        "status"=>"success",					        "code"=>"200"					 		   ];	    			    		}	    	}else{	    		$in_time = date('H:i:s');	    	if (mysqli_query($dbc,"INSERT INTO emp_attendance(att_date,att_sts,emp_id,location,description,in_time) VALUES('$att_date','$att_sts','$emp_id','$location','$description','$in_time')")) {				 $data = [			        'message'=>"Attendance Marked. Employee Checked IN",			        "status"=>"success",			        "code"=>"200"			 		   ];		   		}else{   				 	$data = [				        'message'=>mysqli_error($dbc),				        "status"=>"fail",				        "code"=>"201"			 		   ];		    	} 	    	}//num rows			}//distance coding	}//atendance mark action	/*Attendance View by QR*/	if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="view_attendance") {		$details=[];			 if(isset($_REQUEST['from']) AND isset($_REQUEST['to'])){				$from = date('Y-m-d',strtotime($_REQUEST['from']));				$to = date('Y-m-d',strtotime($_REQUEST['to']));				$para='action=date_wise&from='.$from."&to=".$to;				if(!empty($_REQUEST['emp_id'])){					$getAttendance=mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE emp_id='$_REQUEST[emp_id]' AND att_date BETWEEN '$from' AND '$to' ORDER BY att_id DESC");				}else{					$getAttendance=mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE att_date BETWEEN '$from' AND '$to' ORDER BY att_id DESC");				}			}else{				$date = date('Y-m-d');				$para='action=current&date='.$date;				if(!empty($_REQUEST['emp_id'])){				$getAttendance=mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE emp_id='$_REQUEST[emp_id]' AND att_date LIKE '%$date%' ORDER BY att_add_date DESC");				}else{					$getAttendance=mysqli_query($dbc,"SELECT * FROM emp_attendance WHERE att_date LIKE '%$date%' ORDER BY att_add_date DESC");				}			} 			while($fetchAttendance=mysqli_fetch_assoc($getAttendance)){					$employee=mysqli_fetch_assoc(mysqli_query($dbc,"SELECT * FROM users WHERE user_id='$fetchAttendance[emp_id]'"));				    					if (!empty($fetchAttendance)) {					 					 if (!empty($fetchAttendance['in_time'])) {					 	$start_time=strtotime($fetchAttendance['in_time']); 						$open_time=strtotime("08:00:00");					 									if( (($start_time-$open_time)/60)>5){							 $details[] = array_merge($fetchAttendance,$employee,["attendance_status"=>"late"]);							}else{								$details[] = array_merge($fetchAttendance,$employee,["attendance_status"=>""]);							}					 }						if(!empty($fetchAttendance['out_time'])){							$start = strtotime($fetchAttendance['in_time']); 							$end = strtotime($fetchAttendance['out_time']); 							$totaltime = ($end - $start)  ; 							$h = intval($totaltime / 3600);   							$seconds_remain = ($totaltime - ($h * 3600)); 							$m = intval($seconds_remain / 60);   							$s = ($seconds_remain - ($m * 60)); 						}				}					}//while					$data=[						"status"=>"200",						"details"=>$details					];	    }//if isset	      /* Update Device Code */  if (!empty($_REQUEST['action']) AND $_REQUEST['action']=="update_device_code" AND !empty($_REQUEST['emp_id']) AND !empty($_REQUEST['device_id'])) {  	$check=mysqli_num_rows(mysqli_query($dbc,"SELECT device_id FROM users WHERE device_id='$_REQUEST[device_id]'"));  	if ($check==0) {  		$fetchUserData = mysqli_fetch_assoc(mysqli_query($dbc,"SELECT * FROM users WHERE user_id='$_REQUEST[emp_id]'"));  		if (empty($fetchUserData['device_id'])) {  			$q=mysqli_query($dbc,"UPDATE users SET device_id='$_REQUEST[device_id]' WHERE user_id='$_REQUEST[emp_id]'");	   		 if($q){				 $data = [			      	"message"=>"Device ID has been Updated",			        "status"=>"success",			        "code"=>"200"			      ];        			    }else{			        $data = [			        'message'=>mysqli_error($dbc),				        "status"=>"fail",			        "code"=>"400"			    	];			        			    }  		}else{  			$data = [		        'message'=>$_REQUEST['device_id']." can not used because some ID is already used",			        "status"=>"fail",		        "code"=>"200"		    ];  		}  	}else{  		$data = [		        'message'=>$_REQUEST['device_id']." is already used",			        "status"=>"fail",		        "code"=>"200"		    ];  	}       	}//action update device id	/*json response*/	if (!empty($data)) {		echo json_encode($data);	}else{		echo "No Data Found";	}